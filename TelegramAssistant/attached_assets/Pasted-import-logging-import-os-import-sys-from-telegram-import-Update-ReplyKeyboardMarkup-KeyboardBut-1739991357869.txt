import logging
import os
import sys
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
from database import Database

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
BOT_TOKEN = os.getenv('BOT_TOKEN')
ADMIN_ID = int(os.getenv('ADMIN_ID', '0'))

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
db = Database()

class TelegramBot:
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞"""
        self.app = None

    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
        try:
            if not update.effective_user:
                logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ")
                return

            user_id = update.effective_user.id
            logger.info(f"–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /start –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

            if user_id != ADMIN_ID:
                logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –æ—Ç –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
                await update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É!")
                return

            # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
            keyboard = [
                [KeyboardButton("üìù –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ")],
                [KeyboardButton("üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π")],
                [KeyboardButton("üë• –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤")],
                [KeyboardButton("‚ùå –£–¥–∞–ª–∏—Ç—å —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —É–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö")],
                [KeyboardButton("‚ûï –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É —á–∞—Ç–æ–≤")] #Added button for creating chat groups
            ]
            reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

            await update.message.reply_text(
                "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                reply_markup=reply_markup
            )
            logger.info(f"–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ /start: {e}", exc_info=True)
            await self.error_handler(update, context)

    async def help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
        try:
            if not update.effective_user:
                logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ")
                return

            user_id = update.effective_user.id
            logger.info(f"–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /help –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

            if user_id != ADMIN_ID:
                logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –æ—Ç –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
                await update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É")
                return

            help_text = """
üìå *–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã*
/start - –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∏ –≤—Ö–æ–¥ –≤ –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–ø—Ä–∞–≤–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
/addchat - –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π —á–∞—Ç –≤ —Å–ø–∏—Å–æ–∫ —É–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö
/remove_chat - –£–¥–∞–ª–∏—Ç—å —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —É–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö
/list_chats - –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤

üìù *–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è–º–∏*
‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–∞–¥–∞–Ω–∏–π
‚Ä¢ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–¥–∞–Ω–∏–π –≤ —á–∞—Ç—ã
‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π
‚Ä¢ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

üë• *–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏*
‚Ä¢ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ /addchat
‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø —á–∞—Ç–æ–≤
‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–º —á–∞—Ç–æ–≤
‚Ä¢ –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–æ–≤

üí° *–°–æ–≤–µ—Ç*
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /addchat –≤ –∫–∞–∂–¥–æ–º —á–∞—Ç–µ, –∫–æ—Ç–æ—Ä—ã–º —Ö–æ—Ç–∏—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å.
–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã —á–∞—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª –≤ –º–µ–Ω—é.
"""
            await update.message.reply_text(help_text, parse_mode='Markdown')
            logger.info(f"–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ—â–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ /help: {e}", exc_info=True)
            await self.error_handler(update, context)

    async def show_statistics(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–æ—Ç–∞"""
        try:
            if not update.message or not update.effective_user:
                return

            user_id = update.effective_user.id
            if user_id != ADMIN_ID:
                await update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏!")
                return

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            keyboard = [
                [KeyboardButton("üìä –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è"), KeyboardButton("üìà –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")],
                [KeyboardButton("üîô –ù–∞–∑–∞–¥")]
            ]
            reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

            await update.message.reply_text(
                "üìä –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:",
                reply_markup=reply_markup
            )
            logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ–Ω—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ–Ω—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}", exc_info=True)
            await self.error_handler(update, context)

    async def show_general_statistics(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–ü–æ–∫–∞–∑–∞—Ç—å –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
        try:
            # Using the proper database query method
            stats = db.execute_query("""
                SELECT 
                    (SELECT COUNT(*) FROM chats) as total_chats,
                    (SELECT COUNT(*) FROM tasks WHERE status = 'active') as active_tasks,
                    (SELECT COUNT(*) FROM tasks WHERE status = 'completed') as completed_tasks,
                    (SELECT COUNT(*) FROM responses WHERE status = 'completed') as total_responses
            """)[0]

            stats_text = (
                "üìä *–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞*\n\n"
                f"üë• –ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —á–∞—Ç—ã: {stats['total_chats']}\n"
                f"üìù –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è: {stats['active_tasks']}\n"
                f"‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è: {stats['completed_tasks']}\n"
                f"üì® –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã: {stats['total_responses']}\n\n"
                "ü§ñ *–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ*\n"
                f"‚Ä¢ –°—Ç–∞—Ç—É—Å: –ê–∫—Ç–∏–≤–µ–Ω\n"
                f"‚Ä¢ –í–µ—Ä—Å–∏—è: 1.0\n"
                f"‚Ä¢ –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: {context.bot_data.get('start_time', '–ù/–î')}"
            )

            keyboard = [
                [KeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å")],
                [KeyboardButton("üîô –ù–∞–∑–∞–¥")]
            ]
            reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

            await update.message.reply_text(
                stats_text,
                parse_mode='Markdown',
                reply_markup=reply_markup
            )
            logger.info("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}", exc_info=True)
            await update.message.reply_text("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")


    async def show_settings(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞"""
        try:
            keyboard = [
                [KeyboardButton("üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏"), KeyboardButton("üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è")],
                [KeyboardButton("üîê –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞"), KeyboardButton("‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è")],
                [KeyboardButton("üîô –ù–∞–∑–∞–¥"), KeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")]
            ]
            reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

            await update.message.reply_text(
                "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫:",
                reply_markup=reply_markup
            )
            logger.info("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: {e}", exc_info=True)
            await self.error_handler(update, context)

    async def show_main_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏"""
        try:
            keyboard = [
                [KeyboardButton("üìù –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ")],
                [KeyboardButton("üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π")],
                [KeyboardButton("üë• –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤")],
                [KeyboardButton("üë• –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É —á–∞—Ç–æ–≤")],
                [KeyboardButton("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏"), KeyboardButton("‚ùì –ü–æ–º–æ—â—å")]
            ]
            reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

            logger.info("–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏")
            await update.message.reply_text(
                "üìã –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
                reply_markup=reply_markup
            )
            logger.info("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —É—Å–ø–µ—à–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é: {e}", exc_info=True)
            await self.error_handler(update, context)

    async def start_new_task(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–ù–∞—á–∞–ª–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è"""
        try:
            if not update.effective_user or update.effective_user.id != ADMIN_ID:
                return

            context.user_data['state'] = 'awaiting_task_text'
            keyboard = [
                [KeyboardButton("üîô –û—Ç–º–µ–Ω–∞")]
            ]
            reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

            await update.message.reply_text(
                "üìù –í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ:",
                reply_markup=reply_markup
            )
            logger.info(f"–ó–∞–ø—Ä–æ—à–µ–Ω –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –∑–∞–¥–∞–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {update.effective_user.id}")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è: {e}", exc_info=True)
            await self.error_handler(update, context)

    async def handle_task_text(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∑–∞–¥–∞–Ω–∏—è"""
        try:
            if not update.effective_user or update.effective_user.id != ADMIN_ID:
                return

            task_text = update.message.text
            if task_text == "üîô –û—Ç–º–µ–Ω–∞":
                context.user_data.clear()
                await self.show_main_menu(update, context)
                return

            context.user_data['task_text'] = task_text
            context.user_data['state'] = 'choosing_recipient_type'

            keyboard = [
                [KeyboardButton("üë• –ì—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã")],
                [KeyboardButton("üë§ –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è")],
                [KeyboardButton("üìã –ì—Ä—É–ø–ø—ã —á–∞—Ç–æ–≤")],
                [KeyboardButton("üîô –û—Ç–º–µ–Ω–∞")]
            ]
            reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

            await update.message.reply_text(
                "üì® –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π:",
                reply_markup=reply_markup
            )
            logger.info(f"–°–æ—Ö—Ä–∞–Ω–µ–Ω —Ç–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è, –æ–∂–∏–¥–∞–µ—Ç—Å—è –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞ –∑–∞–¥–∞–Ω–∏—è: {e}", exc_info=True)
            await self.error_handler(update, context)

    async def handle_recipient_type(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π"""
        try:
            if not update.effective_user or update.effective_user.id != ADMIN_ID:
                return

            recipient_type = update.message.text
            if recipient_type == "üîô –û—Ç–º–µ–Ω–∞":
                context.user_data.clear()
                await self.show_main_menu(update, context)
                return

            context.user_data['recipient_type'] = recipient_type

            if recipient_type == "üë• –ì—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã":
                # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–æ–≤
                chats = db.execute_query(
                    "SELECT chat_id, title FROM chats WHERE is_group = 1"
                )
                keyboard = [
                    [KeyboardButton(f"‚¨ú {chat['title']}")] for chat in chats
                ]
            elif recipient_type == "üë§ –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è":
                # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤
                chats = db.execute_query(
                    "SELECT chat_id, title FROM chats WHERE is_group = 0"
                )
                keyboard = [
                    [KeyboardButton(f"‚¨ú {chat['title']}")] for chat in chats
                ]
            else:  # "üìã –ì—Ä—É–ø–ø—ã —á–∞—Ç–æ–≤"
                # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø
                groups = db.get_chat_groups(update.effective_user.id)
                keyboard = [
                    [KeyboardButton(f"‚¨ú {group['name']}")] for group in groups
                ]

            keyboard.extend([
                [KeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å")],
                [KeyboardButton("üîô –û—Ç–º–µ–Ω–∞")]
            ])
            reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

            await update.message.reply_text(
                "‚úèÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –∑–∞–¥–∞–Ω–∏—è:\n"
                "(–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –¥–ª—è –≤—ã–±–æ—Ä–∞, –∑–∞—Ç–µ–º '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å')",
                reply_markup=reply_markup
            )
            context.user_data['state'] = 'selecting_recipients'
            context.user_data['selected_titles'] = set()
            logger.info(f"–û—Ç–æ–±—Ä–∞–∂–µ–Ω —Å–ø–∏—Å–æ–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π —Ç–∏–ø–∞ {recipient_type}")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–∏–ø–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π: {e}", exc_info=True)
            await self.error_handler(update, context)

    async def handle_recipient_selection(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π"""
        try:
            if not update.effective_user or update.effective_user.id != ADMIN_ID:
                return

            selection = update.message.text
            if selection == "üîô –û—Ç–º–µ–Ω–∞":
                context.user_data.clear()
                await self.show_main_menu(update, context)
                return

            if selection == "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å":
                selected_recipients = context.user_data.get('selected_recipients', [])
                if not selected_recipients:
                    await update.message.reply_text("‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è")
                    return

                # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞–Ω–∏–µ
                task_id = db.create_task(
                    context.user_data['task_text'],
                    update.effective_user.id
                )

                # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–¥–∞–Ω–∏–µ
                for recipient in selected_recipients:
                    if context.user_data['recipient_type'] == "üìã –ì—Ä—É–ø–ø—ã —á–∞—Ç–æ–≤":
                        db.add_task_recipient(task_id, group_id=recipient['id'])
                        # –ü–æ–ª—É—á–∞–µ–º —á–∞—Ç—ã –≥—Ä—É–ø–ø—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∫–∞–∂–¥—ã–π
                        group_chats = db.get_group_chats(recipient['id'])
                        for chat in group_chats:
                            try:
                                await context.bot.send_message(
                                    chat_id=chat['chat_id'],
                                    text=f"üìå –ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ\n\n{context.user_data['task_text']}"
                                )
                            except Exception as e:
                                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–¥–∞–Ω–∏—è –≤ —á–∞—Ç {chat['chat_id']}: {e}")
                    else:
                        db.add_task_recipient(task_id, chat_id=recipient['chat_id'])
                        try:
                            await context.bot.send_message(
                                chat_id=recipient['chat_id'],
                                text=f"üìå –ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ\n\n{context.user_data['task_text']}"
                            )
                        except Exception as e:
                            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–¥–∞–Ω–∏—è –≤ —á–∞—Ç {recipient['chat_id']}: {e}")

                await update.message.reply_text("‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")
                context.user_data.clear()
                await self.show_main_menu(update, context)
                return

            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—É—á–∞—Ç–µ–ª—è
            if selection.startswith("‚¨ú ") or selection.startswith("‚úÖ "):
                selected_titles = context.user_data.get('selected_titles', set())
                recipient_name = selection[2:]  # –£–±–∏—Ä–∞–µ–º —ç–º–æ–¥–∑–∏ –∏–∑ –Ω–∞—á–∞–ª–∞

                if selection.startswith("‚¨ú "):
                    selected_titles.add(recipient_name)
                else:
                    selected_titles.discard(recipient_name)

                context.user_data['selected_titles'] = selected_titles

                # –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
                if context.user_data['recipient_type'] == "üìã –ì—Ä—É–ø–ø—ã —á–∞—Ç–æ–≤":
                    groups = db.get_chat_groups(update.effective_user.id)
                    keyboard = [
                        [KeyboardButton(f"{'‚úÖ' if group['name'] in selected_titles else '‚¨ú'} {group['name']}")]
                        for group in groups
                    ]
                    selected_recipients = [g for g in groups if g['name'] in selected_titles]
                else:
                    chats = db.execute_query(
                        "SELECT chat_id, title FROM chats WHERE " +
                        ("is_group = 1" if context.user_data['recipient_type'] == "üë• –ì—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã" else "is_group = 0")
                    )
                    keyboard = [
                        [KeyboardButton(f"{'‚úÖ' if chat['title'] in selected_titles else '‚¨ú'} {chat['title']}")]
                        for chat in chats
                    ]
                    selected_recipients = [c for c in chats if c['title'] in selected_titles]

                context.user_data['selected_recipients'] = selected_recipients

                keyboard.extend([
                    [KeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å")],
                    [KeyboardButton("üîô –û—Ç–º–µ–Ω–∞")]
                ])
                reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

                await update.message.reply_text(
                    f"‚úèÔ∏è –í—ã–±—Ä–∞–Ω–æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π: {len(selected_recipients)}\n"
                    "(–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –¥–ª—è –≤—ã–±–æ—Ä–∞/–æ—Ç–º–µ–Ω—ã, –∑–∞—Ç–µ–º '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å')",
                    reply_markup=reply_markup
                )

            logger.info(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω –≤—ã–±–æ—Ä –ø–æ–ª—É—á–∞—Ç–µ–ª—è: {selection}")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π: {e}", exc_info=True)
            await self.error_handler(update, context)

    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
        try:
            if not update.message or not update.effective_user:
                return

            message_text = update.message.text
            user_id = update.effective_user.id

            # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            if user_id != ADMIN_ID:
                return

            current_state = context.user_data.get('state')

            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è –∏ –≥—Ä—É–ø–ø—ã
            if current_state == 'awaiting_task_text':
                await self.handle_task_text(update, context)
                return
            elif current_state == 'choosing_recipient_type':
                await self.handle_recipient_type(update, context)
                return
            elif current_state == 'selecting_recipients':
                await self.handle_recipient_selection(update, context)
                return
            elif current_state == 'awaiting_group_name':
                await self.handle_group_name(update, context)
                return
            elif current_state == 'selecting_chats_for_group':
                await self.handle_chat_selection_for_group(update, context)
                return

            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –º–µ–Ω—é
            if message_text == "üìù –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ":
                await self.start_new_task(update, context)
            elif message_text == "üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π":
                await self.show_active_tasks(update, context)
            elif message_text == "üë• –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤":
                await self.show_chat_list(update, context)
            elif message_text == "‚ùå –£–¥–∞–ª–∏—Ç—å —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —É–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö":
                await self.show_delete_chat_menu(update, context)
            elif message_text == "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞":
                await self.show_statistics(update, context)
            elif message_text == "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏":
                await self.show_settings(update, context)
            elif message_text == "‚ùì –ü–æ–º–æ—â—å":
                await self.help_command(update, context)
            elif message_text == "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
                await self.show_main_menu(update, context)
            elif message_text == "üë• –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É —á–∞—Ç–æ–≤":
                await self.create_chat_group(update, context)
            else:
                await update.message.reply_text(f"‚úâÔ∏è –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: {message_text}")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}", exc_info=True)
            await self.error_handler(update, context)

    async def handle_task_response(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∑–∞–¥–∞–Ω–∏–µ - –æ—Ç–∫–ª—é—á–µ–Ω–∞ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        return

    async def show_active_tasks(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π"""
        try:
            if not update.effective_user or update.effective_user.id != ADMIN_ID:
                return

            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è—Ö
            active_tasks = db.execute_query("""
                SELECT t.text, tr.chat_id, tr.group_id, tr.status, c.title as chat_title, cg.name as group_name
                FROM tasks t
                LEFT JOIN task_recipients tr ON t.id = tr.task_id
                LEFT JOIN chats c ON tr.chat_id = c.chat_id
                LEFT JOIN chat_groups cg ON tr.group_id = cg.id
                WHERE t.status = 'active'
                ORDER BY t.created_at DESC, tr.chat_id, tr.group_id
            """)

            if not active_tasks:
                keyboard = [[KeyboardButton("üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")]]
                reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
                await update.message.reply_text(
                    "üìã –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π",
                    reply_markup=reply_markup
                )
                return

            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–¥–∞–Ω–∏—è –∏ –∏—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
            tasks_grouped = {}
            for task in active_tasks:
                task_text = task['text']
                if task_text not in tasks_grouped:
                    tasks_grouped[task_text] = []

                recipient_name = task['chat_title'] or task['group_name']
                if recipient_name:
                    status_emoji = "‚úÖ" if task['status'] == 'completed' else "‚è≥"
                    tasks_grouped[task_text].append(f"{status_emoji} {recipient_name}")

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ —Å–ø–∏—Å–∫–æ–º –∑–∞–¥–∞–Ω–∏–π
            tasks_text = "üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è:\n\n"
            for task_text, recipients in tasks_grouped.items():
                tasks_text += f"üìå –ó–∞–¥–∞–Ω–∏–µ:\n{task_text}\n\n"
                tasks_text += "–ü–æ–ª—É—á–∞—Ç–µ–ª–∏:\n"
                tasks_text += "\n".join(recipients)
                tasks_text += "\n\n"

            keyboard = [[KeyboardButton("üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")]]
            reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

            await update.message.reply_text(
                tasks_text,
                reply_markup=reply_markup
            )
            logger.info("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π: {e}", exc_info=True)
            await self.error_handler(update, context)

    async def show_chat_list(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤"""
        try:
            if not update.effective_user or update.effective_user.id != ADMIN_ID:
                await update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏!")
                return

            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —á–∞—Ç–æ–≤
            chats = db.execute_query("SELECT chat_id, title, is_group, added_at FROM chats ORDER BY added_at DESC")

            if not chats:
                keyboard = [[KeyboardButton("üîô –ù–∞–∑–∞–¥")]]
                reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
                await update.message.reply_text(
                    "üìù –°–ø–∏—Å–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤ –ø—É—Å—Ç.\n"
                    "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /addchat –≤ –Ω—É–∂–Ω–æ–º —á–∞—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ.",
                    reply_markup=reply_markup
                )
                return

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ —Å–ø–∏—Å–∫–æ–º —á–∞—Ç–æ–≤
            chat_list = "üìã –°–ø–∏—Å–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤:\n\n"
            for chat in chats:
                chat_type = "üë• –ì—Ä—É–ø–ø–∞" if chat['is_group'] else "üë§ –õ–∏—á–Ω—ã–π —á–∞—Ç"
                added_date = chat['added_at'].split()[0] if chat['added_at'] else "–ù/–î"
                chat_list += f"{chat_type}: {chat['title']}\n"
                chat_list += f"ID: {chat['chat_id']}\n"
                chat_list += f"–î–æ–±–∞–≤–ª–µ–Ω: {added_date}\n\n"

            keyboard = [[KeyboardButton("üîô –ù–∞–∑–∞–¥")]]
            reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

            await update.message.reply_text(
                chat_list,
                reply_markup=reply_markup
            )
            logger.info("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤: {e}", exc_info=True)
            await self.error_handler(update, context)

    async def show_delete_chat_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        await update.message.reply_text("–§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ")


    async def error_handler(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
        logger.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {context.error}", exc_info=context.error)
        error_message = "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        if update and update.effective_message:
            try:
                await update.effective_message.reply_text(error_message)
            except Exception as e:
                logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ: {e}")

    async def add_chat_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /addchat"""
        try:
            if not update.effective_user or not update.effective_chat:
                logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏–ª–∏ —á–∞—Ç–µ")
                return

            user_id = update.effective_user.id
            chat_id = update.effective_chat.id
            chat_title = update.effective_chat.title or f"–ß–∞—Ç {chat_id}"

            if user_id != ADMIN_ID:
                logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –æ—Ç –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
                await update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ!")
                return

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —á–∞—Ç –≥—Ä—É–ø–ø–æ–π
            is_group = update.effective_chat.type in ['group', 'supergroup']

            try:
                # –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                db.execute_query(
                    "INSERT OR REPLACE INTO chats (chat_id, title, is_group) VALUES (?, ?, ?)",
                    (chat_id, chat_title, is_group)
                )

                await update.message.reply_text(f"‚úÖ –ß–∞—Ç '{chat_title}' —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫ —É–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö!")
                logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π —á–∞—Ç: {chat_title} (ID: {chat_id})")

            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —á–∞—Ç–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: {e}")
                await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —á–∞—Ç–∞")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ /addchat: {e}", exc_info=True)
            await self.error_handler(update, context)

    async def create_chat_group(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã —á–∞—Ç–æ–≤"""
        try:
            if not update.effective_user or update.effective_user.id != ADMIN_ID:
                return

            context.user_data['state'] = 'awaiting_group_name'
            keyboard = [[KeyboardButton("üîô –û—Ç–º–µ–Ω–∞")]]
            reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

            await update.message.reply_text(
                "üìù –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã —á–∞—Ç–æ–≤:",
                reply_markup=reply_markup
            )

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã —á–∞—Ç–æ–≤: {e}", exc_info=True)
            await self.error_handler(update, context)

    async def handle_group_name(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ –≥—Ä—É–ø–ø—ã"""
        try:
            if not update.effective_user or update.effective_user.id != ADMIN_ID:
                return

            group_name = update.message.text
            if group_name == "üîô –û—Ç–º–µ–Ω–∞":
                context.user_data.clear()
                await self.show_main_menu(update, context)
                return

            # –°–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—É
            group_id = db.create_chat_group(group_name, update.effective_user.id)
            context.user_data['current_group_id'] = group_id
            context.user_data['state'] = 'selecting_chats_for_group'

            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —á–∞—Ç–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞
            chats = db.execute_query(
                "SELECT chat_id, title FROM chats"
            )
            keyboard = [
                [KeyboardButton(f"‚¨ú {chat['title']}")] for chat in chats
            ]
            keyboard.extend([
                [KeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å")],
                [KeyboardButton("üîô –û—Ç–º–µ–Ω–∞")]
            ])
            reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

            await update.message.reply_text(
                "‚úèÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—É:\n"
                "(–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —á–∞—Ç—ã –¥–ª—è –≤—ã–±–æ—Ä–∞, –∑–∞—Ç–µ–º '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å')",
                reply_markup=reply_markup
            )
            context.user_data['selected_titles'] = set()

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–º–µ–Ω–∏ –≥—Ä—É–ø–ø—ã: {e}", exc_info=True)
            await self.error_handler(update, context)

    async def handle_chat_selection_for_group(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —á–∞—Ç–æ–≤ –¥–ª—è –≥—Ä—É–ø–ø—ã"""
        try:
            if not update.effective_user or update.effective_user.id != ADMIN_ID:
                return

            selection = update.message.text
            if selection == "üîô –û—Ç–º–µ–Ω–∞":
                # –£–¥–∞–ª—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—É—é –≥—Ä—É–ø–ø—É
                db.execute_query(
                    "DELETE FROM chat_groups WHERE id = ?",
                    (context.user_data.get('current_group_id'),)
                )
                context.user_data.clear()
                await self.show_main_menu(update, context)
                return

            if selection == "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å":
                selected_chats = context.user_data.get('selected_chats', [])
                if not selected_chats:
                    await update.message.reply_text("‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —á–∞—Ç")
                    return

                # –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–∞—Ç—ã –≤ –≥—Ä—É–ø–ø—É
                group_id = context.user_data['current_group_id']
                for chat in selected_chats:
                    db.add_chat_to_group(group_id, chat['chat_id'])

                await update.message.reply_text(f"‚úÖ –ì—Ä—É–ø–ø–∞ —á–∞—Ç–æ–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!")
                context.user_data.clear()
                await self.show_main_menu(update, context)
                return

            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —á–∞—Ç–∞
            if selection.startswith("‚¨ú ") or selection.startswith("‚úÖ "):
                selected_titles = context.user_data.get('selected_titles', set())
                recipient_name = selection[2:]  # –£–±–∏—Ä–∞–µ–º —ç–º–æ–¥–∑–∏ –∏–∑ –Ω–∞—á–∞–ª–∞

                if selection.startswith("‚¨ú "):
                    selected_titles.add(recipient_name)
                else:
                    selected_titles.discard(recipient_name)

                context.user_data['selected_titles'] = selected_titles

                # –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                chats = db.execute_query("SELECT chat_id, title FROM chats")
                keyboard = [
                    [KeyboardButton(f"{'‚úÖ' if chat['title'] in selected_titles else '‚¨ú'} {chat['title']}")]
                    for chat in chats
                ]
                selected_chats = [c for c in chats if c['title'] in selected_titles]
                context.user_data['selected_chats'] = selected_chats

                keyboard.extend([
                    [KeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å")],
                    [KeyboardButton("üîô –û—Ç–º–µ–Ω–∞")]
                ])
                reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

                await update.message.reply_text(
                    f"‚úèÔ∏è –í—ã–±—Ä–∞–Ω–æ —á–∞—Ç–æ–≤: {len(selected_chats)}\n"
                    "(–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —á–∞—Ç—ã –¥–ª—è –≤—ã–±–æ—Ä–∞/–æ—Ç–º–µ–Ω—ã, –∑–∞—Ç–µ–º '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å')",
                    reply_markup=reply_markup
                )

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —á–∞—Ç–æ–≤ –¥–ª—è –≥—Ä—É–ø–ø—ã: {e}", exc_info=True)
            await self.error_handler(update, context)

    def _register_handlers(self):
        """Register message handlers"""
        # Commands
        self.app.add_handler(CommandHandler("start", self.start_command))
        self.app.add_handler(CommandHandler("help", self.help_command))
        self.app.add_handler(CommandHandler("addchat", self.add_chat_command))

        # Messages
        self.app.add_handler(MessageHandler(
            filters.TEXT & ~filters.COMMAND,
            self.handle_message
        ))

        # Add error handler
        self.app.add_error_handler(self.error_handler)

    def run(self):
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
        if not BOT_TOKEN:
            logger.error("–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ç–æ–∫–µ–Ω –±–æ—Ç–∞!")
            return

        if not ADMIN_ID:
            logger.error("–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!")
            return

        try:
            import asyncio
            logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")

            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ü–∏–∫–ª —Å–æ–±—ã—Ç–∏–π
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)

            # –°–æ–∑–¥–∞–µ–º –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            self.app = Application.builder().token(BOT_TOKEN).build()
            self._register_handlers()

            # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
            logger.info("–ë–æ—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–±–æ—Ç—É...")
            self.app.run_polling(drop_pending_updates=True)

        except KeyboardInterrupt:
            logger.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        except Exception as e:
            logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}", exc_info=True)
            if self.app:
                try:
                    loop = asyncio.get_event_loop()
                    if loop.is_running():
                        loop.stop()
                    loop.close()
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞: {e}")
            sys.exit(1)

if __name__ == "__main__":
    bot = TelegramBot()
    bot.run()